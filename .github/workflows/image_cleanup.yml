name: Image Cleanup

on:
  workflow_call:

jobs:
  cleanup:
    runs-on: ubuntu-24.04
    name: Cleanup Docker Images
    permissions: write-all
    steps:
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete temporary image
        continue-on-error: true
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/obre-app:ci-${{ github.sha }}
          echo "Deleting image: $IMAGE"

          OWNER_TYPE=$(gh api /users/${{ github.repository_owner }} --jq '.type')
          if [ "$OWNER_TYPE" = "Organization" ]; then
            PACKAGE_PATH="/orgs/${{ github.repository_owner }}/packages/container/obre-app/versions"
          else
            PACKAGE_PATH="/user/packages/container/obre-app/versions"
          fi

          PACKAGE_VERSION_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$PACKAGE_PATH" \
            --jq ".[] | select(.metadata.container.tags[] | contains(\"ci-${{ github.sha }}\")) | .id")

          if [ -n "$PACKAGE_VERSION_ID" ]; then
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$PACKAGE_PATH/$PACKAGE_VERSION_ID"
            echo "Image deleted successfully"
          else
            echo "No image found to delete"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
