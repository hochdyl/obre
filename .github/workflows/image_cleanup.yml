name: Image Cleanup

on:
    workflow_call:

jobs:
    cleanup:
        runs-on: ubuntu-24.04
        name: Cleanup Docker Images
        permissions: write-all
        steps:
            - name: Login to Docker Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Delete temporary image
              continue-on-error: true
              run: |
                  IMAGE=ghcr.io/${{ github.repository_owner }}/obre-app:ci-${{ github.sha }}
                  echo "Deleting image: $IMAGE"

                  # Get the package version ID
                  PACKAGE_VERSION_ID=$(gh api \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    /user/packages/container/obre-app/versions \
                    --jq ".[] | select(.metadata.container.tags[] | contains(\"ci-${{ github.sha }}\")) | .id")

                  if [ -n "$PACKAGE_VERSION_ID" ]; then
                    gh api \
                      --method DELETE \
                      -H "Accept: application/vnd.github+json" \
                      -H "X-GitHub-Api-Version: 2022-11-28" \
                      /user/packages/container/obre-app/versions/$PACKAGE_VERSION_ID
                    echo "Image deleted successfully"
                  else
                    echo "No image found to delete"
                  fi
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
